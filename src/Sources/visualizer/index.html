<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Network Graph Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        #header p {
            font-size: 14px;
            opacity: 0.9;
        }

        #controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        #file-input {
            display: none;
        }

        .file-label {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .file-label:hover {
            background: #38a169;
        }

        #stats {
            margin-left: auto;
            padding: 8px 16px;
            background: #edf2f7;
            border-radius: 6px;
            font-size: 14px;
            color: rgb(30,55,95);
        }

        #chart-container {
            width: 100%;
            height: calc(100vh - 160px);
            background: white;
            position: relative;
            overflow: hidden;
        }

        #svg-container {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
            stroke: rgb(30,55,95);
            stroke-width: 2px;
        }

        .node:hover {
            stroke-width: 3px;
        }

        .link {
            fill: none;
            stroke: #2d3748;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3px;
        }

        .node-label {
            font-size: 12px;
            pointer-events: none;
            text-anchor: middle;
            fill: rgb(30,55,95);
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .node-label-background {
            fill: white;
            fill-opacity: 0.8;
        }

        #legend {
            position: absolute;
            top: 160px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 250px;
            font-size: 13px;
            z-index: 10;
        }

        #legend h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: rgb(30,55,95);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }

        .legend-shape {
            width: 30px;
            height: 20px;
            border: 2px solid #2d3748;
            flex-shrink: 0;
        }

        .legend-label {
            color: rgb(30,55,95);
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 350px;
            font-size: 13px;
            display: none;
            z-index: 10;
        }

        #info-panel h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: rgb(30,55,95);
        }

        #info-panel .info-item {
            margin: 6px 0;
            color: rgb(30,55,95);
        }

        #info-panel .info-label {
            font-weight: 600;
            color: rgb(30,55,95);
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>UML Network Graph Visualizer</h1>
        <p>Interactive visualization of undirected weighted graphs using D3.js - Click on nodes to view details</p>
    </div>

    <div id="controls">
        <div class="control-group">
            <label for="file-input" class="file-label">Load JSON</label>
            <input type="file" id="file-input" accept=".json">
        </div>
        <div id="stats">No graph loaded</div>
    </div>

    <div id="chart-container">
        <svg id="svg-container"></svg>
    </div>

    <div id="legend">
        <h3>Node Types</h3>
        <div class="legend-item">
            <div class="legend-shape" style="background: #4299e1; border-radius: 4px;"></div>
            <span class="legend-label">Class</span>
        </div>
        <div class="legend-item">
            <div class="legend-shape" style="background: #9f7aea; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);"></div>
            <span class="legend-label">Enumeration</span>
        </div>
        <div class="legend-item">
            <div class="legend-shape" style="background: #48bb78; border-radius: 50%;"></div>
            <span class="legend-label">Attribute</span>
        </div>
        <div class="legend-item">
            <div class="legend-shape" style="background: #ed8936; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>
            <span class="legend-label">Operation</span>
        </div>
        <div class="legend-item">
            <div class="legend-shape" style="background: #d6bcfa; border-radius: 50%; width: 15px; height: 15px;"></div>
            <span class="legend-label">EnumLiteral</span>
        </div>
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #e2e8f0;">
        <h3>Edge Types</h3>
        <div class="legend-item">
            <div style="width: 30px; height: 2px; background: #2d3748;"></div>
            <span class="legend-label">Association</span>
        </div>
        <div class="legend-item">
            <div style="width: 30px; height: 2px; border-top: 2px dashed #2d3748;"></div>
            <span class="legend-label">Realization</span>
        </div>
        <div class="legend-item">
            <div style="width: 30px; height: 2px; background: #718096;"></div>
            <span class="legend-label">Generalization</span>
        </div>
    </div>

    <div id="info-panel"></div>

    <script>
        let svg, g, simulation;
        let graphData = null;
        let nodes = [];
        let links = [];
        let nodeMap = new Map();

        // Get node visual properties based on type
        function getNodeStyle(nodeType) {
            switch(nodeType) {
                case 'Class':
                    return { fill: '#4299e1', stroke: '#2c5282', radius: 20, shape: 'rect' };
                case 'Enumeration':
                    return { fill: '#9f7aea', stroke: '#6b46c1', radius: 20, shape: 'hexagon' };
                case 'Attribute':
                    return { fill: '#48bb78', stroke: '#2f855a', radius: 15, shape: 'circle' };
                case 'Operation':
                    return { fill: '#ed8936', stroke: '#c05621', radius: 18, shape: 'diamond' };
                case 'EnumLiteral':
                    return { fill: '#d6bcfa', stroke: '#9f7aea', radius: 12, shape: 'circle' };
                case 'AssociationClass':
                    return { fill: '#4fd1c5', stroke: '#2c7a7b', radius: 20, shape: 'rect' };
                default:
                    return { fill: '#718096', stroke: '#4a5568', radius: 15, shape: 'circle' };
            }
        }

        // Draw node shape
        function drawNodeShape(selection, style) {
            selection.each(function(d) {
                const el = d3.select(this);
                el.selectAll('*').remove();
                
                if (style.shape === 'rect') {
                    el.append('rect')
                        .attr('x', -style.radius)
                        .attr('y', -style.radius)
                        .attr('width', style.radius * 2)
                        .attr('height', style.radius * 2)
                        .attr('rx', 4)
                        .attr('fill', style.fill)
                        .attr('stroke', style.stroke);
                } else if (style.shape === 'hexagon') {
                    const points = [];
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i - Math.PI / 6;
                        points.push([
                            Math.cos(angle) * style.radius,
                            Math.sin(angle) * style.radius
                        ]);
                    }
                    el.append('polygon')
                        .attr('points', points.map(p => p.join(',')).join(' '))
                        .attr('fill', style.fill)
                        .attr('stroke', style.stroke);
                } else if (style.shape === 'diamond') {
                    el.append('polygon')
                        .attr('points', [
                            [0, -style.radius].join(','),
                            [style.radius, 0].join(','),
                            [0, style.radius].join(','),
                            [-style.radius, 0].join(',')
                        ].join(' '))
                        .attr('fill', style.fill)
                        .attr('stroke', style.stroke);
                } else { // circle
                    el.append('circle')
                        .attr('r', style.radius)
                        .attr('fill', style.fill)
                        .attr('stroke', style.stroke);
                }
            });
        }

        // Initialize D3.js force-directed graph
        function initGraph() {
            const container = d3.select('#chart-container');
            const width = container.node().clientWidth;
            const height = container.node().clientHeight;

            // Create SVG
            svg = d3.select('#svg-container')
                .attr('width', width)
                .attr('height', height);

            // Create container group for zoom/pan
            g = svg.append('g');

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Create force simulation
            simulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(d => 50 + (d.weight || 1) * 30))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => (d.radius || 20) + 5));

            // Draw empty graph initially
            updateGraph();
        }

        // Update graph visualization
        function updateGraph() {
            if (!simulation) return;

            // Remove existing elements
            g.selectAll('.link').remove();
            g.selectAll('.node').remove();

            if (nodes.length === 0) return;

            // Create links
            const link = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.max(1, Math.min(5, (d.weight || 1) * 2)));

            // Create nodes
            const node = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(drag(simulation));

            // Draw node shapes
            node.each(function(d) {
                const style = getNodeStyle(d.nodeType);
                d.radius = style.radius;
                drawNodeShape(d3.select(this), style);
            });

            // Add labels
            node.append('text')
                .attr('class', 'node-label')
                .text(d => d.label || d.id)
                .attr('dy', d => (d.radius || 20) + 15)
                .attr('dx', 0);

            // Add click handler for nodes
            node.on('click', function(event, d) {
                event.stopPropagation();
                showNodeInfo(d);
            });

            // Click on background to hide info panel
            svg.on('click', function(event) {
                if (event.target === svg.node() || event.target.tagName === 'line') {
                    document.getElementById('info-panel').style.display = 'none';
                }
            });

            // Update positions on simulation tick
            simulation.nodes(nodes).on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Update links
            simulation.force('link').links(links);

            // Restart simulation
            simulation.alpha(1).restart();
        }

        // Drag behavior
        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        // Transform JSON data to D3.js format
        function transformGraphData(data) {
            nodes = [];
            links = [];
            nodeMap = new Map();

            // Process nodes
            if (data.nodes) {
                data.nodes.forEach(node => {
                    const attrs = node.attributes || {};
                    const nodeType = attrs.type || 'Unknown';
                    const nodeName = attrs.name || node.id;
                    
                    const d3Node = {
                        id: node.id,
                        label: nodeName,
                        nodeType: nodeType,
                        attributes: attrs
                    };

                    nodes.push(d3Node);
                    nodeMap.set(node.id, d3Node);
                });
            }

            // Process edges
            if (data.edges) {
                data.edges.forEach(edge => {
                    const source = nodeMap.get(edge.node1);
                    const target = nodeMap.get(edge.node2);
                    if (source && target) {
                        links.push({
                            source: source,
                            target: target,
                            weight: edge.weight || 1
                        });
                    }
                });
            }

            return { nodes, links };
        }

        // Load graph data
        function loadGraphData(data) {
            graphData = data;
            transformGraphData(data);
            updateGraph();
            updateStats();
        }

        // Fit to screen
        function fitToScreen() {
            if (nodes.length === 0) return;

            const bounds = g.node().getBBox();
            const fullWidth = d3.select('#chart-container').node().clientWidth;
            const fullHeight = d3.select('#chart-container').node().clientHeight;
            const width = bounds.width;
            const height = bounds.height;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;

            const scale = 0.9 / Math.max(width / fullWidth, height / fullHeight);
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];

            svg.transition()
                .duration(750)
                .call(
                    d3.zoom().transform,
                    d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
                );
        }

        // Reset layout
        function resetLayout() {
            if (simulation) {
                nodes.forEach(d => {
                    d.fx = null;
                    d.fy = null;
                });
                simulation.alpha(1).restart();
            }
        }

        // Show node information
        function showNodeInfo(node) {
            const infoPanel = document.getElementById('info-panel');
            const attrs = node.attributes || {};
            const nodeType = node.nodeType;
            
            let html = `<h3>${node.label || node.id}</h3>`;
            html += `<div class="info-item"><span class="info-label">Type:</span> ${nodeType}</div>`;
            
            if (attrs.isAbstract) {
                html += `<div class="info-item"><span class="info-label">Abstract:</span> Yes</div>`;
            }
            
            if (attrs.isInterface) {
                html += `<div class="info-item"><span class="info-label">Interface:</span> Yes</div>`;
            }
            
            if (attrs.stereotypes && attrs.stereotypes.length > 0) {
                html += `<div class="info-item"><span class="info-label">Stereotypes:</span> ${attrs.stereotypes.join(', ')}</div>`;
            }
            
            if (attrs.attrType) {
                html += `<div class="info-item"><span class="info-label">Attribute Type:</span> ${attrs.attrType}</div>`;
            }
            
            if (attrs.visibility) {
                html += `<div class="info-item"><span class="info-label">Visibility:</span> ${attrs.visibility}</div>`;
            }
            
            if (attrs.returnType) {
                html += `<div class="info-item"><span class="info-label">Return Type:</span> ${attrs.returnType}</div>`;
            }
            
            if (attrs.params && attrs.params.length > 0) {
                html += `<div class="info-item"><span class="info-label">Parameters:</span><br>`;
                attrs.params.forEach(param => {
                    html += `&nbsp;&nbsp;- ${param.name}${param.type ? ': ' + param.type : ''}<br>`;
                });
                html += `</div>`;
            }
            
            infoPanel.innerHTML = html;
            infoPanel.style.display = 'block';
        }

        // Update statistics
        function updateStats() {
            const stats = document.getElementById('stats');
            if (nodes.length > 0) {
                const nodeCount = nodes.length;
                const edgeCount = links.length;
                stats.textContent = `Nodes: ${nodeCount} | Edges: ${edgeCount}`;
            } else {
                stats.textContent = 'No graph loaded';
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (svg) {
                const container = d3.select('#chart-container');
                const width = container.node().clientWidth;
                const height = container.node().clientHeight;
                svg.attr('width', width).attr('height', height);
                if (simulation) {
                    simulation.force('center', d3.forceCenter(width / 2, height / 2));
                    simulation.alpha(0.3).restart();
                }
            }
        });

        // File input handler
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        loadGraphData(data);
                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });


        // Initialize on load
        window.addEventListener('load', function() {
            initGraph();
            
            // Try to load default data if available
            fetch('graph-data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('File not found');
                    }
                    return response.json();
                })
                .then(data => {
                    loadGraphData(data);
                })
                .catch(error => {
                    console.log('No default graph-data.json found. Please load a JSON file.');
                });
        });
    </script>
</body>
</html>
